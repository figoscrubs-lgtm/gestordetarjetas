<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Tarjetas üí≥</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        header {
            background: #222;
            color: #fff;
            padding: 15px 20px;
        }
        header h1 {
            margin: 0;
            font-size: 20px;
        }
        main {
            padding: 0 20px 20px 20px;
            max-width: 1100px;
            margin: 0 auto;
        }
        nav {
            margin: 0 -20px 15px -20px;
            padding: 10px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: #f5f5f5;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid #ddd;
        }
        nav button {
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            background: #e0e0e0;
        }
        nav button.active {
            background: #4caf50;
            color: #fff;
            font-weight: 600;
        }
        section {
            display: none;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        section.active {
            display: block;
        }
        h2 {
            margin-top: 0;
            font-size: 18px;
        }
        .card {
            border-radius: 8px;
            padding: 12px;
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            margin-bottom: 10px;
        }
        .card-alerta {
            border-radius: 8px;
            padding: 10px 12px;
            background: #fff8e1;
            border: 1px solid #ffe082;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .card-tarjeta {
            background: #fff;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 4px;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 10px;
        }
        .card-tarjeta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            gap: 8px;
        }
        .card-tarjeta-body {
            font-size: 13px;
            color: #444;
        }
        .muted {
            color: #666;
            font-size: 14px;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .form-group {
            flex: 1;
            min-width: 180px;
            margin-bottom: 10px;
        }
        label {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
        }
        input, select {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        input[type="checkbox"] {
            width: auto;
        }
        .btn-primary {
            background: #4caf50;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 5px;
        }
        .btn-secondary, .btn-link {
            background: #e0e0e0;
            color: #333;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-link {
            background: transparent;
            color: #1976d2;
            text-decoration: underline;
            padding: 0;
        }
        .btn-danger {
            background: #f44336;
            color: #fff;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            background: #eee;
            margin-left: 4px;
        }
        .badge.pending {
            background: #ffeb3b;
        }
        .badge.checked {
            background: #c8e6c9;
        }
        .badge-alert {
            background: #ffcc80;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th, td {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        th {
            background: #f0f0f0;
        }
        .right {
            text-align: right;
        }
        .small {
            font-size: 12px;
        }
        .danger {
            color: #d32f2f;
        }
        .success {
            color: #388e3c;
        }
        .stat-box {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        .bar-container {
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            height: 8px;
            margin-bottom: 6px;
        }
        .bar-fill {
            height: 8px;
            background: #4caf50;
        }
        .chips {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            background: #eee;
            font-size: 11px;
            margin-left: 4px;
        }
    </style>

    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
    <h1>Panel de Tarjetas üí≥ ‚Äì Control simple y claro</h1>
</header>
<main>

    <!-- NAV FIJO ARRIBA -->
    <nav>
        <button data-section="sec-recomendacion" class="active">üè† Inicio</button>
        <button data-section="sec-verTarjetas">üìã Ver tarjetas</button>
        <button data-section="sec-nuevaTarjeta">‚ûï Nueva tarjeta</button>
        <button data-section="sec-recomendacion">üí∏ Nuevo movimiento</button>
        <button data-section="sec-pagos">üíµ Registrar pago</button>
        <button data-section="sec-movFijos">üîÅ Movimientos fijos</button>
        <button data-section="sec-proximasCuotas">üìÖ Pr√≥ximas cuotas</button>
        <button data-section="sec-historial">üìö Historial</button>
        <button data-section="sec-estadisticas">üìä Estad√≠sticas</button>
    </nav>

    <!-- INICIO -->
    <section id="sec-recomendacion" class="active">
        <h2>üîî Alertas importantes</h2>
        <div id="alertasVencimiento" class="muted">
            Sin alertas por ahora.
        </div>

        <hr style="margin:15px 0;">

        <h2>‚≠ê Tarjeta recomendada para usar hoy</h2>
        <div id="recomendacionContenido" class="muted">
            Cargando tarjetas...
        </div>

        <hr style="margin:15px 0;">

        <h2>üí∏ Registrar nuevo movimiento r√°pido</h2>
        <form id="formMovimiento">
            <div class="form-row">
                <div class="form-group">
                    <label>Tarjeta üí≥</label>
                    <select id="movCardSelect" required></select>
                </div>
                <div class="form-group">
                    <label>Fecha del movimiento üìÜ</label>
                    <input type="date" id="movDate" required>
                </div>
                <div class="form-group">
                    <label>Monto (Gs) üí∞</label>
                    <input type="text" id="movAmount" required placeholder="Ej: 2.500.000">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Descripci√≥n üìù</label>
                    <input type="text" id="movDescription" required placeholder="Ej: Celular, s√∫per, etc.">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="movIsInstallment">
                        ¬øEs en cuotas? (si NO, dej√° desmarcado)
                    </label>
                    <input type="number" id="movInstallmentsCount" min="1" step="1" value="1" placeholder="Cantidad de cuotas">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="movHasCashback">
                        ¬øTiene reintegro (cashback)?
                    </label>
                    <input type="number" id="movCashbackPercent" min="0" max="100" step="1" placeholder="% reintegro">
                </div>
            </div>
            <button type="submit" class="btn-primary">Guardar movimiento üíæ</button>
        </form>
        <p class="small muted">
            Si marc√°s ‚ÄúEs en cuotas‚Äù, el sistema genera autom√°ticamente las cuotas mensuales iguales.
        </p>

        <h3 class="small" style="margin-top:15px;">üìú √öltimos movimientos cargados</h3>
        <div id="listaMovimientosRecientes"></div>
        <p class="small muted">
            ‚úÖ actualiza el saldo de la tarjeta.  
            üóë elimina el movimiento si lo cargaste mal.
        </p>
    </section>

    <!-- Ver tarjetas -->
    <section id="sec-verTarjetas">
        <h2>üìã Resumen de tarjetas</h2>
        <div id="listaTarjetas"></div>
    </section>

    <!-- Nueva tarjeta -->
    <section id="sec-nuevaTarjeta">
        <h2>‚ûï Registrar nueva tarjeta</h2>
        <form id="formTarjeta">
            <div class="form-row">
                <div class="form-group">
                    <label>Nombre de la tarjeta üè∑Ô∏è</label>
                    <input type="text" id="cardName" required placeholder="Ej: Visa Gold, Mastercard Cl√°sica‚Ä¶">
                </div>
                <div class="form-group">
                    <label>Banco / Emisor üè¶</label>
                    <input type="text" id="cardBank" placeholder="Ej: Banco Atlas, Ita√∫, etc.">
                </div>
                <div class="form-group">
                    <label>Tasa de inter√©s anual (%) üìà</label>
                    <input type="number" id="cardAnnualRate" min="0" step="0.1" placeholder="Ej: 45">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Fecha de cierre üìÜ</label>
                    <input type="date" id="cardClosingDate" required>
                </div>
                <div class="form-group">
                    <label>Fecha de vencimiento üìÖ</label>
                    <input type="date" id="cardDueDate" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>L√≠mite de cr√©dito (Gs) üí∞</label>
                    <input type="text" id="cardLimit" required placeholder="Ej: 5.000.000">
                </div>
                <div class="form-group">
                    <label>Saldo actual adeudado (Gs) üîª</label>
                    <input type="text" id="cardCurrentBalance" required placeholder="Ej: 1.200.000">
                </div>
            </div>
            <button type="submit" class="btn-primary">Guardar tarjeta üíæ</button>
        </form>
    </section>

    <!-- Registrar pago -->
    <section id="sec-pagos">
        <h2>üíµ Registrar pago a tarjeta</h2>
        <form id="formPago">
            <div class="form-row">
                <div class="form-group">
                    <label>Tarjeta üí≥</label>
                    <select id="payCardSelect" required></select>
                </div>
                <div class="form-group">
                    <label>Fecha del pago üìÜ</label>
                    <input type="date" id="payDate" required>
                </div>
                <div class="form-group">
                    <label>Monto pagado (Gs) üí∞</label>
                    <input type="text" id="payAmount" required placeholder="Ej: 1.000.000">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Descripci√≥n (opcional) üìù</label>
                    <input type="text" id="payDescription" placeholder="Ej: Pago desde cuenta sueldo">
                </div>
            </div>
            <button type="submit" class="btn-primary">Registrar pago üíæ</button>
        </form>

        <h3 class="small" style="margin-top:15px;">üßæ Pagos recientes</h3>
        <div id="listaPagosRecientes"></div>
        <p class="small muted">
            Cada pago reduce el saldo de la tarjeta.  
            üóë revierte el efecto del pago.
        </p>
    </section>

    <!-- Movimientos fijos -->
    <section id="sec-movFijos">
        <h2>üîÅ Movimientos fijos (mantenimiento, suscripciones, etc.)</h2>
        <form id="formMovFijo">
            <div class="form-row">
                <div class="form-group">
                    <label>Tarjeta üí≥</label>
                    <select id="fixCardSelect" required></select>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n üìù</label>
                    <input type="text" id="fixDescription" required placeholder="Ej: Netflix, mantenimiento tarjeta‚Ä¶">
                </div>
                <div class="form-group">
                    <label>Monto mensual (Gs) üí∞</label>
                    <input type="text" id="fixAmount" required placeholder="Ej: 50.000">
                </div>
                <div class="form-group">
                    <label>D√≠a de cobro (1-31) üìÜ</label>
                    <input type="number" id="fixChargeDay" min="1" max="31" required>
                </div>
            </div>
            <button type="submit" class="btn-primary">Guardar movimiento fijo üíæ</button>
        </form>

        <h3 class="small" style="margin-top:15px;">Lista de movimientos fijos</h3>
        <div id="listaMovFijos"></div>
        <p class="small muted">
            ‚úÖ marca que ya se cobr√≥ este mes y suma al saldo de la tarjeta.  
            üóë elimina el movimiento fijo si ya no lo us√°s.
        </p>
    </section>

    <!-- Pr√≥ximas cuotas -->
    <section id="sec-proximasCuotas">
        <h2>üìÖ Pr√≥ximas cuotas a pagar</h2>
        <div id="listaCuotas"></div>
        <p class="small muted">
            ‚úÖ marca una cuota como chequeada (actualiza saldo).  
            üóë elimina la cuota si la cargaste por error.
        </p>
    </section>

    <!-- Historial -->
    <section id="sec-historial">
        <h2>üìö Historial de actividades</h2>
        <div id="historialContenido"></div>
        <p class="small muted">
            Rojo = deuda generada (compras/cuotas, fijos).  
            Verde = pagos que reducen la deuda.
        </p>
    </section>

    <!-- Estad√≠sticas -->
    <section id="sec-estadisticas">
        <h2>üìä Estad√≠sticas generales</h2>
        <div id="estadisticasContenido"></div>
        <p class="small muted">
            El pago m√≠nimo se calcula con un porcentaje configurable (por defecto 15% de la deuda).  
            Los intereses son estimaciones aproximadas usando la tasa anual que carg√°s en cada tarjeta.
        </p>
    </section>

</main>

<script>
    // ====== Supabase: pon√© tus datos ac√° ======
    const SUPABASE_URL = 'https://ekxfpybwtlppxpdswmai.supabase.co';  // <- reemplazar
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVreGZweWJ3dGxwcHhwZHN3bWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4ODM1NDYsImV4cCI6MjA3ODQ1OTU0Nn0.9PViBzf0jHp45qyQ1NWMyDaYERgp-m5mWQi5hzBtEy4';            // <- reemplazar

    let supabaseClient = null;
    if (window.supabase) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.error('Supabase no configurado correctamente.');
    }

    // Estado en memoria (no hay localStorage)
    let state = {
        cards: [],
        installments: [],
        fixedMovements: [],
        payments: []
    };

    // No hacen nada, s√≥lo para que el resto del c√≥digo no explote
    function saveState() {}
    function loadState() {}

    const PAGO_MINIMO_PORC = 0.15; // 15%

    function parseDate(str) {
        if (!str) return null;
        const d = new Date(str);
        return isNaN(d.getTime()) ? null : d;
    }

    function diffDays(from, to) {
        const ms = to - from;
        return Math.ceil(ms / (1000 * 60 * 60 * 24));
    }

    function formatDateDMY(str) {
        const d = parseDate(str);
        if (!d) return '-';
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}-${month}-${year}`;
    }

    function formatDateDMYFromDate(d) {
        if (!d) return '-';
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}-${month}-${year}`;
    }

    function formatGs(n) {
        if (isNaN(n)) return '-';
        return n.toLocaleString('es-PY', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }) + ' Gs';
    }

    // Inputs de dinero con puntos de miles
    function setupMoneyInput(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('input', () => {
            let val = el.value;
            const digits = val.replace(/\D/g, '');
            if (!digits) {
                el.value = '';
                return;
            }
            const n = parseInt(digits, 10);
            el.value = n.toLocaleString('es-PY', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        });
    }

    function getMoneyValue(id) {
        const el = document.getElementById(id);
        if (!el || !el.value) return 0;
        const digits = el.value.replace(/\./g, '').replace(/,/g, '');
        return Number(digits) || 0;
    }

    async function updateCardBalance(cardId, delta) {
        if (!supabaseClient) return;
        const card = state.cards.find(c => c.id === cardId);
        if (!card) return;
        const current = Number(card.current_balance) || 0;
        const newBalance = current + delta;

        const { data, error } = await supabaseClient
            .from('cards')
            .update({ current_balance: newBalance })
            .eq('id', cardId)
            .select()
            .single();

        if (error) {
            console.error('Error actualizando saldo de tarjeta:', error);
            return;
        }
        if (data) {
            Object.assign(card, data);
        }
    }

    // Avanzar ciclos de cierre/vencimiento al siguiente mes si quedaron en el pasado
    async function normalizeCardCycles() {
        if (!supabaseClient) return;
        const today = new Date();
        today.setHours(0,0,0,0);

        function nextMonthlyDate(dateStr) {
            const d = parseDate(dateStr);
            if (!d) return null;
            d.setHours(0,0,0,0);
            const t = new Date(today);
            t.setHours(0,0,0,0);
            while (d < t) {
                d.setMonth(d.getMonth() + 1);
            }
            return d;
        }

        for (const card of state.cards) {
            let changed = false;
            let newClosingStr = card.closing_date;
            let newDueStr = card.due_date;

            if (card.due_date) {
                const nextDue = nextMonthlyDate(card.due_date);
                if (nextDue) {
                    const s = nextDue.toISOString().slice(0,10);
                    if (s !== card.due_date) {
                        newDueStr = s;
                        changed = true;
                    }
                }
            }
            if (card.closing_date) {
                const nextClose = nextMonthlyDate(card.closing_date);
                if (nextClose) {
                    const s = nextClose.toISOString().slice(0,10);
                    if (s !== card.closing_date) {
                        newClosingStr = s;
                        changed = true;
                    }
                }
            }

            if (changed) {
                const { data, error } = await supabaseClient
                    .from('cards')
                    .update({
                        closing_date: newClosingStr,
                        due_date: newDueStr
                    })
                    .eq('id', card.id)
                    .select()
                    .single();
                if (!error && data) {
                    Object.assign(card, data);
                }
            }
        }
    }

    // ====== Navegaci√≥n ======
    const navButtons = document.querySelectorAll('nav button');
    const sections = document.querySelectorAll('main section');

    function setActiveSection(id) {
        sections.forEach(sec => {
            sec.classList.toggle('active', sec.id === id);
        });
        navButtons.forEach(b => {
            b.classList.toggle('active', b.dataset.section === id);
        });
    }

    navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.dataset.section;
            setActiveSection(targetId);
        });
    });

    window.openSection = function(id) {
        const btn = document.querySelector(`nav button[data-section="${id}"]`);
        if (btn) btn.click();
        else setActiveSection(id);
    };

    // ====== Selects de tarjetas ======
    function renderCardSelects() {
        const movSel = document.getElementById('movCardSelect');
        const fixSel = document.getElementById('fixCardSelect');
        const paySel = document.getElementById('payCardSelect');
        [movSel, fixSel, paySel].forEach(sel => {
            sel.innerHTML = '';
            if (!state.cards.length) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Primero carg√° una tarjeta';
                sel.appendChild(opt);
                sel.disabled = true;
            } else {
                sel.disabled = false;
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Seleccion√° tarjeta...';
                sel.appendChild(placeholder);
                state.cards.forEach(card => {
                    const opt = document.createElement('option');
                    opt.value = card.id;
                    opt.textContent = card.name;
                    sel.appendChild(opt);
                });
            }
        });
    }

    // ====== Ver tarjetas ======
    function renderCardsView() {
        const cont = document.getElementById('listaTarjetas');
        if (!state.cards.length) {
            cont.innerHTML = '<p class="muted">Todav√≠a no hay tarjetas cargadas.</p>';
            return;
        }
        const hoy = new Date();
        let html = '';
        state.cards.forEach(card => {
            const limite = Number(card.credit_limit) || 0;
            const saldo = Number(card.current_balance) || 0;
            const disponible = limite - saldo;
            const due = parseDate(card.due_date);
            let diasTxt = '-';
            if (due) {
                const dias = diffDays(hoy, due);
                diasTxt = `${dias} d√≠as`;
            }
            const bank = card.bank_name && card.bank_name.trim() ? card.bank_name.trim() : 'Sin banco';
            const rate = Number(card.annual_rate) || 0;

            html += `
                <div class="card-tarjeta">
                    <div class="card-tarjeta-header">
                        <div>
                            <span>üí≥ ${card.name}</span>
                            <span class="chips">${bank}</span>
                        </div>
                        <div style="text-align:right;">
                            <div class="small muted">L√≠mite: <b>${formatGs(limite)}</b></div>
                            <button class="btn-secondary btn-danger small" onclick="deleteCard('${card.id}')">üóë Eliminar</button>
                        </div>
                    </div>
                    <div class="card-tarjeta-body">
                        <div class="small">
                            Cierre: <b>${formatDateDMY(card.closing_date)}</b> |
                            Venc.: <b>${formatDateDMY(card.due_date)}</b> |
                            D√≠as hasta venc.: <b>${diasTxt}</b>
                        </div>
                        <div class="small">
                            Saldo actual: <span class="danger"><b>${formatGs(saldo)}</b></span>
                        </div>
                        <div class="small">
                            Saldo disponible: <span class="success"><b>${formatGs(disponible)}</b></span>
                        </div>
                        <div class="small muted">
                            Tasa anual: <b>${rate ? rate.toFixed(1) + ' %' : 'no cargada'}</b>
                        </div>
                    </div>
                </div>
            `;
        });
        cont.innerHTML = html;
    }

    // ====== Alertas de vencimiento y escenarios ======
    function renderAlerts() {
        const cont = document.getElementById('alertasVencimiento');
        if (!state.cards.length) {
            cont.innerHTML = '<span class="muted">Carg√° una tarjeta para ver alertas.</span>';
            return;
        }

        const hoy = new Date();
        const alertas = [];

        state.cards.forEach(card => {
            const due = parseDate(card.due_date);
            if (!due) return;
            const dias = diffDays(hoy, due);
            const saldo = Number(card.current_balance) || 0;
            const rate = Number(card.annual_rate) || 0;
            if (saldo <= 0) return;

            if (dias <= 10) {
                const pagoTotal = saldo;
                const pagoMin = saldo * PAGO_MINIMO_PORC;
                const saldoPostMin = saldo - pagoMin;

                let tasaMensual = 0;
                let interesMes = 0;
                let totalConInteres = saldoPostMin;
                let extraVsPagarTodo = 0;

                if (rate > 0) {
                    tasaMensual = (rate / 100) / 12;
                    interesMes = saldoPostMin * tasaMensual;
                    totalConInteres = saldoPostMin + interesMes;
                    extraVsPagarTodo = interesMes;
                }

                alertas.push({
                    card,
                    dias,
                    pagoTotal,
                    pagoMin,
                    saldoPostMin,
                    interesMes,
                    totalConInteres,
                    extraVsPagarTodo
                });
            }
        });

        if (!alertas.length) {
            cont.innerHTML = '<span class="muted">Sin alertas importantes por ahora.</span>';
            return;
        }

        alertas.sort((a, b) => a.dias - b.dias);

        let html = '';
        alertas.forEach(a => {
            html += `
                <div class="card-alerta">
                    <div>
                        <b>üí≥ ${a.card.name}</b>
                        <span class="badge badge-alert">faltan ${a.dias} d√≠as</span>
                    </div>
                    <div class="small">
                        Deuda actual: <b>${formatGs(a.pagoTotal)}</b><br>
                        Si cancel√°s todo ahora: <b>${formatGs(a.pagoTotal)}</b><br>
                        Pago m√≠nimo (aprox. ${(PAGO_MINIMO_PORC*100).toFixed(0)}%): <b>${formatGs(a.pagoMin)}</b><br>
                        Deuda que quedar√≠a si pag√°s s√≥lo el m√≠nimo: <b>${formatGs(a.saldoPostMin)}</b><br>
                        ${
                            a.interesMes > 0
                            ? `Inter√©s aprox. el pr√≥ximo mes sobre esa deuda: <b>${formatGs(a.interesMes)}</b><br>
                               Total aprox. a futuro si pag√°s m√≠nimo y luego todo: <b>${formatGs(a.totalConInteres)}</b><br>
                               Extra que pagar√≠as por no cancelar hoy: <b>${formatGs(a.extraVsPagarTodo)}</b>`
                            : '<span class="muted">Sin tasa anual cargada, no se puede estimar el inter√©s.</span>'
                        }
                    </div>
                </div>
            `;
        });

        cont.innerHTML = html;
    }

    // ====== Recomendaci√≥n ======
    function renderRecommendation() {
        const cont = document.getElementById('recomendacionContenido');
        if (!state.cards.length) {
            cont.innerHTML = `
                No hay tarjetas cargadas todav√≠a.
                <button class="btn-link" onclick="openSection('sec-nuevaTarjeta')">Cargar una tarjeta ahora</button>.
            `;
            return;
        }
        const hoy = new Date();
        let mejor = null;
        let mejorDias = -Infinity;

        state.cards.forEach(card => {
            const due = parseDate(card.due_date);
            if (!due) return;
            const dias = diffDays(hoy, due);
            if (dias > mejorDias) {
                mejorDias = dias;
                mejor = card;
            }
        });

        if (!mejor) {
            cont.innerHTML = 'No se pudo calcular recomendaci√≥n. Revis√° las fechas de vencimiento.';
            return;
        }

        const limite = Number(mejor.credit_limit) || 0;
        const saldo = Number(mejor.current_balance) || 0;
        const disponible = limite - saldo;

        cont.innerHTML = `
            <div class="card">
                <strong>Tarjeta sugerida: ${mejor.name} üí≥</strong><br>
                <span class="small">
                    Cierre: ${formatDateDMY(mejor.closing_date)} |
                    Vencimiento: ${formatDateDMY(mejor.due_date)} |
                    D√≠as hasta vencimiento: <b>${mejorDias}</b>
                </span><br>
                <span class="small">
                    L√≠mite: ${formatGs(limite)} |
                    Saldo actual: ${formatGs(saldo)} |
                    Disponible: ${formatGs(disponible)}
                </span>
                <p class="muted small" style="margin-top:6px;">
                    L√≥gica: se sugiere la tarjeta con m√°s d√≠as hasta el pr√≥ximo vencimiento.
                </p>
            </div>
        `;
    }

    // ====== Pr√≥ximas cuotas ======
    function renderInstallments() {
        const cont = document.getElementById('listaCuotas');
        if (!state.installments.length) {
            cont.innerHTML = '<p class="muted">No hay cuotas pendientes cargadas.</p>';
            return;
        }
        const hoy = new Date();
        const list = [...state.installments].sort((a, b) => {
            const da = parseDate(a.due_date) || hoy;
            const db = parseDate(b.due_date) || hoy;
            return da - db;
        });

        let html = '<table><thead><tr>' +
            '<th>Tarjeta</th><th>Descripci√≥n</th><th>Cuota</th><th>Vence</th>' +
            '<th class="right">Monto</th><th>Estado</th><th></th>' +
            '</tr></thead><tbody>';

        list.forEach(inst => {
            const card = state.cards.find(c => c.id === inst.card_id);
            const cardName = card ? card.name : 'Tarjeta eliminada';
            const due = parseDate(inst.due_date);
            const dias = due ? diffDays(new Date(), due) : null;
            let estado = inst.checked ? '<span class="badge checked">Chequeado</span>' :
                '<span class="badge pending">Pendiente</span>';
            if (!inst.checked && dias !== null && dias < 0) {
                estado += ' <span class="danger small">‚ö† vencida</span>';
            }

            html += `<tr>
                <td>${cardName}</td>
                <td>${inst.description}</td>
                <td>${inst.number}/${inst.total_count}</td>
                <td>${formatDateDMY(inst.due_date)}</td>
                <td class="right">${formatGs(Number(inst.amount) || 0)}</td>
                <td>${estado}</td>
                <td>
                    <button class="btn-secondary" onclick="toggleInstallmentChecked('${inst.id}')">‚úÖ</button>
                    <button class="btn-secondary btn-danger" onclick="deleteInstallment('${inst.id}')">üóë</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        cont.innerHTML = html;
    }

    // ====== Movimientos recientes ======
    function renderRecentMovements() {
        const cont = document.getElementById('listaMovimientosRecientes');
        if (!state.installments.length) {
            cont.innerHTML = '<p class="muted">Todav√≠a no registraste movimientos.</p>';
            return;
        }
        const list = [...state.installments]
            .sort((a, b) => {
                const ta = a.created_at ? new Date(a.created_at).getTime() : 0;
                const tb = b.created_at ? new Date(b.created_at).getTime() : 0;
                return tb - ta;
            })
            .slice(0, 10);

        let html = '<table><thead><tr>' +
            '<th>Tarjeta</th><th>Descripci√≥n</th><th>Cuota</th><th>Fecha</th>' +
            '<th class="right">Monto</th><th>Estado</th><th></th>' +
            '</tr></thead><tbody>';

        list.forEach(inst => {
            const card = state.cards.find(c => c.id === inst.card_id);
            const cardName = card ? card.name : 'Tarjeta eliminada';
            const due = parseDate(inst.due_date);
            const dias = due ? diffDays(new Date(), due) : null;
            let estado = inst.checked ? '<span class="badge checked">Chequeado</span>' :
                '<span class="badge pending">Pendiente</span>';
            if (!inst.checked && dias !== null && dias < 0) {
                estado += ' <span class="danger small">‚ö† vencida</span>';
            }

            html += `<tr>
                <td>${cardName}</td>
                <td>${inst.description}</td>
                <td>${inst.number}/${inst.total_count}</td>
                <td>${formatDateDMY(inst.due_date)}</td>
                <td class="right">${formatGs(Number(inst.amount) || 0)}</td>
                <td>${estado}</td>
                <td>
                    <button class="btn-secondary" onclick="toggleInstallmentChecked('${inst.id}')">‚úÖ</button>
                    <button class="btn-secondary btn-danger" onclick="deleteInstallment('${inst.id}')">üóë</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        cont.innerHTML = html;
    }

    // ====== Movimientos fijos ======
    function renderFixedMovements() {
        const cont = document.getElementById('listaMovFijos');
        if (!state.fixedMovements.length) {
            cont.innerHTML = '<p class="muted">No hay movimientos fijos cargados.</p>';
            return;
        }
        const hoy = new Date();
        const mesClaveActual = hoy.getFullYear() + '-' + (hoy.getMonth() + 1);

        let html = '<table><thead><tr>' +
            '<th>Tarjeta</th><th>Descripci√≥n</th><th>D√≠a de cobro</th>' +
            '<th class="right">Monto</th><th>Estado este mes</th><th></th>' +
            '</tr></thead><tbody>';

        state.fixedMovements.forEach(fix => {
            const card = state.cards.find(c => c.id === fix.card_id);
            const cardName = card ? card.name : 'Tarjeta eliminada';
            const pendiente = fix.last_checked_month !== mesClaveActual;
            const estado = pendiente
                ? '<span class="badge pending">Pendiente</span>'
                : '<span class="badge checked">Chequeado</span>';

            html += `<tr>
                <td>${cardName}</td>
                <td>${fix.description}</td>
                <td>${fix.charge_day}</td>
                <td class="right">${formatGs(Number(fix.amount) || 0)}</td>
                <td>${estado}</td>
                <td>
                    <button class="btn-secondary" onclick="toggleFixedChecked('${fix.id}')">‚úÖ</button>
                    <button class="btn-secondary btn-danger" onclick="deleteFixed('${fix.id}')">üóë</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        cont.innerHTML = html;
    }

    // ====== Pagos recientes ======
    function renderPaymentsRecent() {
        const cont = document.getElementById('listaPagosRecientes');
        if (!state.payments.length) {
            cont.innerHTML = '<p class="muted">Todav√≠a no registraste pagos.</p>';
            return;
        }
        const list = [...state.payments]
            .sort((a, b) => {
                const ta = a.created_at ? new Date(a.created_at).getTime() : 0;
                const tb = b.created_at ? new Date(b.created_at).getTime() : 0;
                return tb - ta;
            })
            .slice(0, 10);

        let html = '<table><thead><tr>' +
            '<th>Tarjeta</th><th>Descripci√≥n</th><th>Fecha</th>' +
            '<th class="right">Monto pagado</th><th></th>' +
            '</tr></thead><tbody>';

        list.forEach(pay => {
            const card = state.cards.find(c => c.id === pay.card_id);
            const cardName = card ? card.name : 'Tarjeta eliminada';
            const d = pay.date ? formatDateDMY(pay.date) :
                (pay.created_at ? formatDateDMYFromDate(new Date(pay.created_at)) : '-');

            html += `<tr>
                <td>${cardName}</td>
                <td>${pay.description || 'Pago a tarjeta'}</td>
                <td>${d}</td>
                <td class="right success"><b>${formatGs(Number(pay.amount) || 0)}</b></td>
                <td>
                    <button class="btn-secondary btn-danger" onclick="deletePayment('${pay.id}')">üóë</button>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        cont.innerHTML = html;
    }

    // ====== Historial ======
    function renderHistory() {
        const cont = document.getElementById('historialContenido');
        const eventos = [];

        state.installments.forEach(inst => {
            eventos.push({
                type: 'cuota',
                createdAt: inst.created_at ? new Date(inst.created_at).getTime() : 0,
                card_id: inst.card_id,
                description: inst.description + (inst.total_count > 1 ? ` (cuota ${inst.number}/${inst.total_count})` : ''),
                date: inst.due_date,
                amount: Number(inst.amount) || 0
            });
        });

        state.payments.forEach(pay => {
            eventos.push({
                type: 'pago',
                createdAt: pay.created_at ? new Date(pay.created_at).getTime() : 0,
                card_id: pay.card_id,
                description: pay.description || 'Pago a tarjeta',
                date: pay.date,
                amount: Number(pay.amount) || 0
            });
        });

        state.fixedMovements.forEach(fix => {
            eventos.push({
                type: 'fijo',
                createdAt: fix.created_at ? new Date(fix.created_at).getTime() : 0,
                card_id: fix.card_id,
                description: 'Mov. fijo: ' + fix.description,
                date: null,
                amount: Number(fix.amount) || 0
            });
        });

        if (!eventos.length) {
            cont.innerHTML = '<p class="muted">Todav√≠a no hay actividades registradas.</p>';
            return;
        }

        eventos.sort((a, b) => b.createdAt - a.createdAt);

        let html = '<table><thead><tr>' +
            '<th>Fecha</th><th>Tipo</th><th>Tarjeta</th><th>Descripci√≥n</th>' +
            '<th class="right">Monto</th>' +
            '</tr></thead><tbody>';

        eventos.forEach(ev => {
            const card = state.cards.find(c => c.id === ev.card_id);
            const cardName = card ? card.name : 'Tarjeta eliminada';
            const tipo = ev.type === 'pago' ? 'Pago' :
                         ev.type === 'cuota' ? 'Deuda (cuota)' :
                         'Deuda fija';
            const d = ev.date ? formatDateDMY(ev.date) :
                (ev.createdAt ? formatDateDMYFromDate(new Date(ev.createdAt)) : '-');

            const isPago = ev.type === 'pago';
            const cls = isPago ? 'success' : 'danger';
            const sign = isPago ? '-' : '+';

            html += `<tr>
                <td>${d}</td>
                <td>${tipo}</td>
                <td>${cardName}</td>
                <td>${ev.description}</td>
                <td class="right ${cls}"><b>${sign} ${formatGs(ev.amount)}</b></td>
            </tr>`;
        });

        html += '</tbody></table>';
        cont.innerHTML = html;
    }

    // ====== Estad√≠sticas ======
    function renderStats() {
        const cont = document.getElementById('estadisticasContenido');
        const totalSaldo = state.cards.reduce((acc, c) => acc + (Number(c.current_balance) || 0), 0);
        const pagoMinimo = totalSaldo * PAGO_MINIMO_PORC;
        const remanente = totalSaldo - pagoMinimo;

        const cuotasPendientes = state.installments.filter(i => !i.checked);
        const totalCuotasPend = cuotasPendientes.reduce((acc, i) => acc + (Number(i.amount) || 0), 0);

        const totalFijosMes = state.fixedMovements.reduce((acc, f) => acc + (Number(f.amount) || 0), 0);

        let html = '';

        html += `<div class="stat-box">
            <div class="small muted">Deuda total actual (suma de saldos)</div>
            <div class="success"><strong>${formatGs(totalSaldo)}</strong></div>
        </div>`;

        html += `<div class="stat-box">
            <div class="small muted">Pago m√≠nimo estimado (${(PAGO_MINIMO_PORC*100).toFixed(0)}%)</div>
            <div class="danger"><strong>${formatGs(pagoMinimo)}</strong></div>
        </div>`;

        html += `<div class="stat-box">
            <div class="small muted">Deuda que seguir√≠a si solo pag√°s el m√≠nimo</div>
            <div><strong>${formatGs(remanente)}</strong></div>
        </div>`;

        html += `<div style="margin-top:15px;"></div>`;

        html += `<div class="stat-box">
            <div class="small muted">Cuotas pendientes (cantidad)</div>
            <div><strong>${cuotasPendientes.length}</strong></div>
        </div>`;

        html += `<div class="stat-box">
            <div class="small muted">Total en cuotas pendientes</div>
            <div><strong>${formatGs(totalCuotasPend)}</strong></div>
        </div>`;

        html += `<div class="stat-box">
            <div class="small muted">Total mensual de movimientos fijos</div>
            <div><strong>${formatGs(totalFijosMes)}</strong></div>
        </div>`;

        const bancos = {};
        state.cards.forEach(card => {
            const bank = card.bank_name && card.bank_name.trim() ? card.bank_name.trim() : 'Sin banco';
            const saldo = Number(card.current_balance) || 0;
            if (!bancos[bank]) bancos[bank] = 0;
            bancos[bank] += saldo;
        });

        if (Object.keys(bancos).length) {
            html += `<div style="margin-top:20px;">
                <div class="small muted">Deuda total por banco</div>
                <table>
                    <thead><tr><th>Banco</th><th class="right">Deuda total</th></tr></thead>
                    <tbody>
            `;
            Object.keys(bancos).forEach(bank => {
                html += `<tr>
                    <td>${bank}</td>
                    <td class="right">${formatGs(bancos[bank])}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        }

        if (state.cards.length) {
            const maxSaldo = state.cards.reduce((max, c) => {
                const s = Number(c.current_balance) || 0;
                return s > max ? s : max;
            }, 0);
            html += `<div style="margin-top:20px;">
                <div class="small muted">Deuda por tarjeta (barras proporcionales)</div>
            `;
            state.cards.forEach(card => {
                const saldo = Number(card.current_balance) || 0;
                const ancho = maxSaldo > 0 ? (saldo / maxSaldo * 100) : 0;
                html += `
                    <div class="small">${card.name} ‚Äì ${formatGs(saldo)}</div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width:${ancho}%;"></div>
                    </div>
                `;
            });
            html += '</div>';
        }

        if (state.cards.length) {
            const hoy = new Date();
            html += `<div style="margin-top:20px;">
                <div class="small muted">Detalle por tarjeta: vencimiento, intereses y escenarios de pago</div>
            `;
            state.cards.forEach(card => {
                const saldo = Number(card.current_balance) || 0;
                const rate = Number(card.annual_rate) || 0;
                const due = parseDate(card.due_date);
                const vencStr = formatDateDMY(card.due_date);
                let diasTxt = 'sin fecha';
                let dias = null;
                if (due) {
                    dias = diffDays(hoy, due);
                    diasTxt = `faltan ${dias} d√≠as`;
                }

                const pagoTotal = saldo;
                const pagoMin = saldo * PAGO_MINIMO_PORC;
                const saldoPostMin = saldo - pagoMin;

                let interesMes = 0;
                let totalConInteres = saldoPostMin;
                let extraVsPagarTodo = 0;

                if (rate > 0 && saldo > 0) {
                    const tasaMensual = (rate / 100) / 12;
                    interesMes = saldoPostMin * tasaMensual;
                    totalConInteres = saldoPostMin + interesMes;
                    extraVsPagarTodo = interesMes;
                }

                html += `<div class="small" style="margin-top:6px;">
                    <b>${card.name}</b> (${card.bank_name || 'sin banco'})<br>
                    Deuda actual: <b>${formatGs(saldo)}</b><br>
                    Vencimiento: <b>${vencStr}</b> ‚Äì ${diasTxt}.<br>
                    Tasa anual: <b>${rate ? rate.toFixed(1) + ' %' : 'no cargada'}</b><br><br>
                    üëâ Si cancel√°s todo ahora: pag√°s <b>${formatGs(pagoTotal)}</b>.<br>
                    üëâ Si pag√°s s√≥lo el m√≠nimo (~${(PAGO_MINIMO_PORC*100).toFixed(0)}%): pag√°s <b>${formatGs(pagoMin)}</b>,<br>
                    &nbsp;&nbsp;&nbsp;te queda deuda aprox.: <b>${formatGs(saldoPostMin)}</b>.<br>
                    ${
                        rate && saldo
                        ? `üëâ Inter√©s aprox. sobre esa deuda el siguiente mes: <b>${formatGs(interesMes)}</b>.<br>
                           üëâ Total aprox. si luego cancel√°s todo: <b>${formatGs(totalConInteres)}</b>.<br>
                           üîé Costo extra de no pagar todo hoy: <b>${formatGs(extraVsPagarTodo)}</b>.`
                        : 'Sin tasa anual no se puede estimar el inter√©s, pero los montos de pago m√≠nimo s√≠ son v√°lidos.'
                    }
                </div>`;
            });
            html += '</div>';
        }

        cont.innerHTML = html;
    }

    // ====== Render global ======
    function renderAll() {
        renderCardSelects();
        renderCardsView();
        renderAlerts();
        renderRecommendation();
        renderInstallments();
        renderRecentMovements();
        renderFixedMovements();
        renderPaymentsRecent();
        renderHistory();
        renderStats();
    }

    // ====== Acciones (async) ======
    window.toggleInstallmentChecked = async function(id) {
        if (!supabaseClient) return;
        const inst = state.installments.find(i => i.id === id);
        if (!inst) return;
        const apply = !inst.checked;
        const monto = Number(inst.amount) || 0;
        if (apply) {
            await updateCardBalance(inst.card_id, monto);
        } else {
            await updateCardBalance(inst.card_id, -monto);
        }
        const { data, error } = await supabaseClient
            .from('installments')
            .update({ checked: apply })
            .eq('id', id)
            .select()
            .single();
        if (error) {
            console.error('Error actualizando cuota:', error);
            return;
        }
        if (data) {
            Object.assign(inst, data);
            renderAll();
        }
    };

    window.deleteInstallment = async function(id) {
        if (!supabaseClient) return;
        const inst = state.installments.find(i => i.id === id);
        if (!inst) return;
        if (!confirm('¬øEliminar este movimiento/cuota?')) return;
        if (inst.checked) {
            const monto = Number(inst.amount) || 0;
            await updateCardBalance(inst.card_id, -monto);
        }
        const { error } = await supabaseClient
            .from('installments')
            .delete()
            .eq('id', id);
        if (error) {
            console.error('Error eliminando cuota:', error);
            return;
        }
        state.installments = state.installments.filter(i => i.id !== id);
        renderAll();
    };

    window.toggleFixedChecked = async function(id) {
        if (!supabaseClient) return;
        const fix = state.fixedMovements.find(f => f.id === id);
        if (!fix) return;
        const hoy = new Date();
        const mesClave = hoy.getFullYear() + '-' + (hoy.getMonth() + 1);
        const pendiente = fix.last_checked_month !== mesClave;
        const monto = Number(fix.amount) || 0;
        let newLast = fix.last_checked_month;

        if (pendiente) {
            await updateCardBalance(fix.card_id, monto);
            newLast = mesClave;
        } else {
            await updateCardBalance(fix.card_id, -monto);
            newLast = null;
        }

        const { data, error } = await supabaseClient
            .from('fixed_movements')
            .update({ last_checked_month: newLast })
            .eq('id', id)
            .select()
            .single();
        if (error) {
            console.error('Error actualizando movimiento fijo:', error);
            return;
        }
        if (data) {
            Object.assign(fix, data);
            renderAll();
        }
    };

    window.deleteFixed = async function(id) {
        if (!supabaseClient) return;
        const fix = state.fixedMovements.find(f => f.id === id);
        if (!fix) return;
        if (!confirm('¬øEliminar este movimiento fijo?')) return;
        const { error } = await supabaseClient
            .from('fixed_movements')
            .delete()
            .eq('id', id);
        if (error) {
            console.error('Error eliminando movimiento fijo:', error);
            return;
        }
        state.fixedMovements = state.fixedMovements.filter(f => f.id !== id);
        renderAll();
    };

    window.deletePayment = async function(id) {
        if (!supabaseClient) return;
        const pay = state.payments.find(p => p.id === id);
        if (!pay) return;
        if (!confirm('¬øEliminar este pago y revertir su efecto sobre el saldo?')) return;
        const monto = Number(pay.amount) || 0;
        await updateCardBalance(pay.card_id, monto);
        const { error } = await supabaseClient
            .from('payments')
            .delete()
            .eq('id', id);
        if (error) {
            console.error('Error eliminando pago:', error);
            return;
        }
        state.payments = state.payments.filter(p => p.id !== id);
        renderAll();
    };

    window.deleteCard = async function(id) {
        if (!supabaseClient) return;
        const card = state.cards.find(c => c.id === id);
        if (!card) return;
        if (!confirm('¬øEliminar esta tarjeta y todos sus movimientos asociados?')) return;
        const { error } = await supabaseClient
            .from('cards')
            .delete()
            .eq('id', id);
        if (error) {
            console.error('Error eliminando tarjeta:', error);
            return;
        }
        state.cards = state.cards.filter(c => c.id !== id);
        state.installments = state.installments.filter(i => i.card_id !== id);
        state.fixedMovements = state.fixedMovements.filter(f => f.card_id !== id);
        state.payments = state.payments.filter(p => p.card_id !== id);
        renderAll();
    };

    // ====== Formularios (Supabase) ======
    document.getElementById('formTarjeta').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!supabaseClient) return alert('Supabase no est√° configurado');

        const name = document.getElementById('cardName').value.trim();
        const bank_name = document.getElementById('cardBank').value.trim();
        const annual_rate = Number(document.getElementById('cardAnnualRate').value) || 0;
        const closing_date = document.getElementById('cardClosingDate').value;
        const due_date = document.getElementById('cardDueDate').value;
        const credit_limit = getMoneyValue('cardLimit');
        const current_balance = getMoneyValue('cardCurrentBalance');

        if (!name || !closing_date || !due_date || !credit_limit) return;

        const { data, error } = await supabaseClient
            .from('cards')
            .insert([{
                name,
                bank_name,
                annual_rate,
                closing_date,
                due_date,
                credit_limit,
                current_balance
            }])
            .select()
            .single();

        if (error) {
            console.error('Error insertando tarjeta:', error);
            alert('Error guardando tarjeta');
            return;
        }

        state.cards.push(data);
        e.target.reset();
        renderAll();
        alert('Tarjeta guardada ‚úÖ');
    });

    document.getElementById('formMovimiento').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!supabaseClient) return alert('Supabase no est√° configurado');

        const card_id = document.getElementById('movCardSelect').value;
        const dateStr = document.getElementById('movDate').value;
        const amountTotal = getMoneyValue('movAmount');
        const description = document.getElementById('movDescription').value.trim();
        const isInstallment = document.getElementById('movIsInstallment').checked;
        const installmentsCount = Number(document.getElementById('movInstallmentsCount').value) || 1;
        const has_cashback = document.getElementById('movHasCashback').checked;
        const cashback_percent = Number(document.getElementById('movCashbackPercent').value) || 0;

        if (!card_id || !dateStr || !amountTotal || !description) return;

        const baseDate = parseDate(dateStr) || new Date();

        let rows = [];
        if (isInstallment && installmentsCount > 1) {
            const montoCuota = Math.round(amountTotal / installmentsCount);
            for (let i = 1; i <= installmentsCount; i++) {
                const d = new Date(baseDate);
                d.setMonth(d.getMonth() + (i - 1));
                rows.push({
                    card_id,
                    description,
                    due_date: d.toISOString().slice(0,10),
                    amount: montoCuota,
                    number: i,
                    total_count: installmentsCount,
                    checked: false,
                    has_cashback,
                    cashback_percent
                });
            }
        } else {
            const d = parseDate(dateStr) || new Date();
            rows.push({
                card_id,
                description,
                due_date: d.toISOString().slice(0,10),
                amount: amountTotal,
                number: 1,
                total_count: 1,
                checked: false,
                has_cashback,
                cashback_percent
            });
        }

        const { data, error } = await supabaseClient
            .from('installments')
            .insert(rows)
            .select();

        if (error) {
            console.error('Error insertando movimiento/cuotas:', error);
            alert('Error guardando movimiento');
            return;
        }

        state.installments.push(...data);
        e.target.reset();
        renderAll();
        alert('Movimiento guardado ‚úÖ');
    });

    document.getElementById('formMovFijo').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!supabaseClient) return alert('Supabase no est√° configurado');

        const card_id = document.getElementById('fixCardSelect').value;
        const description = document.getElementById('fixDescription').value.trim();
        const amount = getMoneyValue('fixAmount');
        const charge_day = Number(document.getElementById('fixChargeDay').value) || 1;

        if (!card_id || !description || !amount || !charge_day) return;

        const { data, error } = await supabaseClient
            .from('fixed_movements')
            .insert([{
                card_id,
                description,
                amount,
                charge_day,
                last_checked_month: null
            }])
            .select()
            .single();

        if (error) {
            console.error('Error insertando movimiento fijo:', error);
            alert('Error guardando movimiento fijo');
            return;
        }

        state.fixedMovements.push(data);
        e.target.reset();
        renderAll();
        alert('Movimiento fijo guardado ‚úÖ');
    });

    document.getElementById('formPago').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!supabaseClient) return alert('Supabase no est√° configurado');

        const card_id = document.getElementById('payCardSelect').value;
        const date = document.getElementById('payDate').value;
        const amount = getMoneyValue('payAmount');
        const description = document.getElementById('payDescription').value.trim();

        if (!card_id || !date || !amount) return;

        await updateCardBalance(card_id, -amount);

        const { data, error } = await supabaseClient
            .from('payments')
            .insert([{
                card_id,
                date,
                amount,
                description
            }])
            .select()
            .single();

        if (error) {
            console.error('Error insertando pago:', error);
            alert('Error guardando pago');
            return;
        }

        state.payments.push(data);
        e.target.reset();
        renderAll();
        alert('Pago registrado ‚úÖ');
    });

    // ====== Carga inicial desde Supabase ======
    async function loadAllFromSupabase() {
        if (!supabaseClient) {
            renderAll();
            return;
        }
        try {
            const [cardsRes, instRes, fixRes, payRes] = await Promise.all([
                supabaseClient.from('cards').select('*').order('created_at', { ascending: true }),
                supabaseClient.from('installments').select('*').order('created_at', { ascending: true }),
                supabaseClient.from('fixed_movements').select('*').order('created_at', { ascending: true }),
                supabaseClient.from('payments').select('*').order('created_at', { ascending: true })
            ]);

            if (cardsRes.error) console.error('Error cards:', cardsRes.error);
            if (instRes.error) console.error('Error installments:', instRes.error);
            if (fixRes.error) console.error('Error fixed_movements:', fixRes.error);
            if (payRes.error) console.error('Error payments:', payRes.error);

            state.cards = cardsRes.data || [];
            state.installments = instRes.data || [];
            state.fixedMovements = fixRes.data || [];
            state.payments = payRes.data || [];

            await normalizeCardCycles();
            renderAll();
        } catch (err) {
            console.error('Error general cargando datos desde Supabase:', err);
        }
    }

    // ====== Init ======
    loadState(); // no hace nada, s√≥lo por compatibilidad
    ['cardLimit', 'cardCurrentBalance', 'movAmount', 'fixAmount', 'payAmount'].forEach(setupMoneyInput);
    renderAll();
    loadAllFromSupabase();
</script>

</body>
</html>
